# Internal Flash Structure and Emulated EEPROM Example on PSOC 63 MCU

## I. Flash's Structure of PSOC 63 MCU

### Structure:
- PSOC 63 MCU implement dual core architecture with both core have shared access to memory. The MCU will access to flash memory through the code region in the address map.
- Flash memory is divided into 3 main regions which include Supervisory Flash (SFlash), Auxiliary Flash (AUXFlash), Application Flash. Each region is used for specific purpose:
    + Application Flash stores code images and constant data. Therefore, this region have the largest space compare to the rest . User have read and program/erase access to this region but due to Erase Disturb mechanism, it is recommended to store frequently-updated data on another region.
    + Auxiliary Flash provides more storing space when Application Flash's space is not enough. This region is typically used for EEPROM emulation which is benefit for storing log data updated on daily basis.
    + Supervisory Flash is reserved for system use. It contain trim parameter, system configuration parameter, protection and security settings, boot code and other Infineon proprietary information. User can read data from this region but program or erase access is limited.
- A region comprised of sectors and each sector is subdivided into rows. Row's size is 512 bytes. The distribution of rows and sectors is illustrated with the following diagram:
    + SFlash and AUXFlash have 2 sectors with each sector consist of 64 rows. The size of a sector in SFLASH and AUXFlash annotated in parentheses is 32kB.
    + Application Flash have 4 sectors with each sector consist of 512 rows. The size of a sector in Application FLash is 256kB.

![ Flash's Internal Organization.](/Flash_Structure.png)

- The following table list the address range of each region in CPU's address map:

| Address range | Region | Size |
| ------- | ----- | ----- |
| 0x1000 0000 - 0x100F FFFF | Application Flash | 1MB|
| 0x1400 0000 - 0x1400 7FFF | Auxiliary Flash | 32KB |
| 0x1600 0000 - 0x1600 7FFF | Supervisory Flash | 32KB |

- The read and program/erase access to flash memory are implemented as system call with IPC message communication mechanism. System call is a type of NMI exception's trigger to Cortex M0+. All system call will be serviced by Cortex M0+. Other processor(s) will add the function opcode and argument, which is the pointer to the data structure in SRAM, for the desired flash memory access to dedicated IPC mailbox, then trigger dedicated notify event. After detecting the trigger, Cortex M0+  will branch to NMI exception handler inside SROM from the initialized address in vector table. From there, the flash management API programmed by Infineon will execute flash operation corresponding to the opcode in IPC mailbox. The operation's result is returned in driver context together with a release event generated by Cortex M0+.

## II. Emulated EEPROM Example:
